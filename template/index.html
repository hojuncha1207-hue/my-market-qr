<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>장바구니 QR 주문 시스템</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
        }
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .product-list, .cart-section {
            flex: 1;
            min-width: 300px;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1, h2 {
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .product-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .product-item button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        .product-item button:hover { background-color: #0056b3; }
        .cart-item { list-style: none; padding: 5px 0; }
        #cart-items { padding-left: 0; }
        .order-button-container { text-align: center; margin-top: 20px; }
        #order-button {
            width: 100%;
            padding: 15px;
            font-size: 1.2em;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        #order-button:hover { background-color: #218838; }
        #qr-code-container {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
        }
    </style>
</head>
<body>

    <h1>경동시장 상품 주문</h1>

    <div class="container">
        <div class="product-list">
            <h2>판매 상품</h2>
            <div id="product-list-items"></div>
        </div>

        <div class="cart-section">
            <h2>장바구니</h2>
            <ul id="cart-items">
                <li>장바구니가 비어있습니다.</li>
            </ul>
            <div class="order-button-container">
                <button id="order-button" onclick="generateOrderQR()">주문 QR코드 생성</button>
            </div>
            <div id="qr-code-container" style="display:none;">
                <h3>주문 정보 QR코드</h3>
                <div id="qrcode"></div>
                <p>이 QR코드를 직원에게 보여주세요.</p>
            </div>
        </div>
    </div>

<script>
// --- 1. 데이터베이스(DB) 대신 사용할 가게 데이터 ---
const storeData = [
  { "고유ID":0,"가게이름":"수희과일","가게분류":"청과물","main_product":"곶감,딸기,레몬,망고,멜론,바나나,배,복숭아,사과,샤인머스켓,수박,씨없는수박,오랜지,오렌지,자두,참외,체리,키위,토마토,포도","위치":"가-42/경동시장로","특징":"신선한 제철 과일과 다양한 수입 과일을 취급합니다. 여름에는 특히 복숭아, 수박 등 당도 높은 과일이 인기가 많습니다.","좌표":"910,244","연결":""},
  { "고유ID":1,"가게이름":"안동상회","가게분류":"청과물","main_product":"귤,딸기,멜론,방울토마토,사과,수박,홍시","위치":"가-43/경동시장로","특징":"계절별로 인기 있는 과일 위주로 판매하며, 여름에는 멜론과 수박이 특히 인기가 많습니다.","좌표":"910,266","연결":""},
  { "고유ID":2,"가게이름":"소문난반찬","가게분류":"가공식품","main_product":"갈치속젓,게장,명란젓,새우장,전복장","위치":"가-44/경동시장로","특징":"밥도둑으로 유명한 게장을 전문적으로 판매하며, 다양한 해산물 장류와 젓갈류도 맛볼 수 있습니다.","좌표":"910,290","연결":""},
  { "고유ID":3,"가게이름":"한양상회","가게분류":"농산물","main_product":"깻잎),대파,버섯(느타리,새송이),시금치,쌈채소(상추,양파","위치":"가-45/경동시장로","특징":"요리에 필수적인 기본 채소와 함께 다양한 쌈 채소를 판매합니다.","좌표":"910,310","연결":""},
  { "고유ID":4,"가게이름":"대동상회","가게분류":"청과물","main_product":"거봉,멜론,복숭아,블루베리,사과,자두,캠벨포도","위치":"가-46/경동시장로","특징":"여름 제철 과일인 복숭아와 자두를 주로 판매하며, 다양한 포도 품종도 취급합니다.","좌표":"910,373","연결":""},
  { "고유ID":5,"가게이름":"태영상회","가게분류":"청과물","main_product":"복숭아,수박,자두,참외,천도복숭아,포도","위치":"가-47/경동시장로","특징":"여름철 당도 높은 수박과 새콤달콤한 자두, 복숭아 등 과일이 주력 상품입니다.","좌표":"910,400","연결":""},
  { "고유ID":7,"가게이름":"일호청과","가게분류":"청과물","main_product":"귤,망고,멜론,방울토마토,수박,참외,토마토,포도","위치":"가-48/경동시장로","특징":"신선한 제철 과일과 함께 간식용 방울토마토나 수입 망고도 판매합니다.","좌표":"910,440","연결":""},
  { "고유ID":8,"가게이름":"청도상회","가게분류":"농산물","main_product":"고추,깻잎,마늘,부추,애호박,양파,오이,쪽파,호박잎","위치":"가-49/경동시장로","특징":"요리에 필요한 신선한 채소와 함께 찌개용 애호박이나 김치 재료로 쓰이는 쪽파를 판매합니다.","좌표":"910,464","연결":""},
  { "고유ID":16,"가게이름":"삼천리자전거","가게분류":"서비스","main_product":"성인용자전거,어린이자전거,자전거,자전거용품,헬멧","위치":"왕산로","특징":"자전거 판매뿐만 아니라 수리 및 정비 서비스도 제공합니다.","좌표":"876,595","연결":""}
];

// --- 2. 장바구니 상태 관리 ---
let cart = [];

// --- 3. 화면 렌더링 및 업데이트 함수들 ---

// 상품 목록을 화면에 렌더링하는 함수
function renderProducts() {
    const productListDiv = document.getElementById('product-list-items');
    productListDiv.innerHTML = ''; // 기존 목록 초기화
    storeData.forEach(store => {
        // 가게가 판매하는 상품들을 쉼표 기준으로 분리
        const products = store.main_product.split(',').filter(p => p.trim() !== '');
        products.forEach(productName => {
            const product = {
                id: `${store.고유ID}_${productName.trim()}`,
                storeName: store.가게이름,
                name: productName.trim()
            };
            const itemHtml = `
                <div class="product-item">
                    <span>${product.name} <strong>(${product.storeName})</strong></span>
                    <button onclick="addToCart('${product.id}', '${product.storeName}', '${product.name}')">담기</button>
                </div>
            `;
            productListDiv.innerHTML += itemHtml;
        });
    });
}

// 장바구니 화면을 업데이트하는 함수
function updateCartDisplay() {
    const cartItemsUl = document.getElementById('cart-items');
    cartItemsUl.innerHTML = ''; // 기존 목록 초기화
    if (cart.length === 0) {
        cartItemsUl.innerHTML = '<li>장바구니가 비어있습니다.</li>';
    } else {
        cart.forEach(item => {
            const itemHtml = `<li class="cart-item">${item.name} (${item.storeName}) - ${item.quantity}개</li>`;
            cartItemsUl.innerHTML += itemHtml;
        });
    }
}

// --- 4. 핵심 로직 함수들 ---

// 장바구니에 상품을 추가하는 함수
function addToCart(productId, storeName, productName) {
    const existingItem = cart.find(item => item.id === productId);
    if (existingItem) {
        existingItem.quantity++;
    } else {
        cart.push({
            id: productId,
            storeName: storeName,
            name: productName,
            quantity: 1
        });
    }
    updateCartDisplay();
}

//⭐️ [미래를 위한 부분] 서버로 주문 정보를 전송하는 함수 (현재는 시뮬레이션)
async function sendOrderToServer(orderData) {
    console.log("--- 서버로 전송될 데이터 (시뮬레이션) ---");
    console.log(orderData);
    
    // 나중에 실제 서버가 생기면 이 부분의 주석을 풀고 사용합니다.
    /*
    try {
        const response = await fetch('https://내서버주소.com/api/create-order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(orderData)
        });
        const result = await response.json();
        console.log("서버로부터 받은 응답:", result);
        return result; // 서버로부터 주문 ID 등을 돌려받을 수 있음
    } catch (error) {
        console.error("서버 전송 실패:", error);
        throw error;
    }
    */
    
    // 현재는 서버가 없으므로 성공했다고 가정하고 즉시 데이터를 반환합니다.
    return Promise.resolve({ success: true, orderId: "LOCAL_ORDER_" + Date.now() });
}


// 주문 QR코드를 생성하는 메인 함수
async function generateOrderQR() {
    if (cart.length === 0) {
        alert("장바구니에 상품을 먼저 담아주세요!");
        return;
    }

    // 카카오톡을 통해 들어왔다고 가정하고, URL에서 사용자 ID를 가져옵니다.
    // 테스트 시에는 주소창에 ?user_id=test_user_123 와 같이 직접 추가해야 합니다.
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('user_id') || 'local_user'; // ID가 없으면 로컬 사용자로 지정

    const orderData = {
        userId: userId,
        items: cart,
        orderTimestamp: new Date().toISOString()
    };
    
    try {
        // 1. (시뮬레이션) 주문 정보를 서버로 전송
        await sendOrderToServer(orderData);

        // 2. 주문 정보를 JSON 문자열로 변환하여 QR 데이터로 사용
        const qrDataString = JSON.stringify(orderData);

        // 3. QR코드 생성
        const qr = qrcode(0, 'M'); // type 0, error correction level 'M'
        qr.addData(qrDataString);
        qr.make();

        // 4. 생성된 QR코드를 화면에 표시
        document.getElementById('qrcode').innerHTML = qr.createImgTag(4, 8);
        document.getElementById('qr-code-container').style.display = 'block';
        alert("QR코드가 생성되었습니다! 아래에서 확인해주세요.");

    } catch(error) {
        alert("QR코드 생성 중 문제가 발생했습니다.");
    }
}


// --- 5. 초기 실행 ---
// 페이지가 로드되면 상품 목록을 렌더링합니다.
window.onload = function() {
    renderProducts();
};

</script>

</body>
</html>